{
  "userInputs": [
    {
      "id": "content-url-input",
      "type": "input",
      "name": "Original Frevana Content URL",
      "description": "Enter the URL of the original content to translate",
      "placeholder": "yourdomain.frevana.com/content/xyz123",
      "required": true
    },
    {
      "id": "target-languages-input",
      "type": "keywords",
      "name": "Target Languages (enter one or more language codes: en, zh, es, ko, hi, ja, pt, ru, de, fr)",
      "description": "Comma-separated language codes (e.g., zh, ja, es)",
      "placeholder": "en, zh, es, ko, hi, ja, pt, ru, de, fr",
      "required": true
    }
  ],
  "workflows": [
    {
      "id": "setup",
      "nameV2": "Setup",
      "type": "script",
      "outputFormat": "text",
      "script": "module.exports = async function() {\n  const contentUrl = data['content-url-input'] || '';\n  const languagesStr = data['target-languages-input'] || '';\n  \n  if (!contentUrl || !languagesStr) throw new Error('URL and languages required');\n  \n  // Extract content ID from URL\n  const urlParts = contentUrl.split('/');\n  const lastPart = urlParts[urlParts.length - 1];\n  const contentId = lastPart.split('-').pop();\n  if (!contentId || contentId.length \u003C 10) throw new Error('Invalid content ID');\n  \n  // Parse target languages\n  const languages = languagesStr.split(',').map(l =\u003E l.trim().toLowerCase()).filter(l =\u003E l);\n  if (languages.length === 0) throw new Error('No valid languages');\n  \n  console.log(`Content ID: ${contentId}`);\n  console.log(`Target languages: ${languages.join(', ')}`);\n  \n  // Download original HTML from S3\n  console.log('Checking existing translations...');\n  const versionsResp = await api.frevanaApi.request('GET', `/s3/content/${contentId}/language-versions`);\n  \n  let existingLanguages = [];\n  if (versionsResp.ok && versionsResp.data?.versions) {\n    existingLanguages = versionsResp.data.versions.map(v =\u003E v.language_code);\n    console.log(`Existing S3 translations: ${existingLanguages.join(', ') || 'none'}`);\n  }\n  \n  // Check local database for existing translations\n  const localTranslations = await api.db.listTranslations({ original_content_id: contentId });\n  const localLanguages = localTranslations.map(t =\u003E t.language_code);\n  console.log(`Existing local translations: ${localLanguages.join(', ') || 'none'}`);\n  \n  const languagesToTranslate = languages.filter(lang =\u003E !localLanguages.includes(lang) && !existingLanguages.includes(lang));\n  console.log(`Languages to translate: ${languagesToTranslate.join(', ') || 'none'}`);\n  \n  let originalHtml = '';\n  if (languagesToTranslate.length \u003E 0) {\n    const firstLang = languagesToTranslate[0];\n    const prepareResp = await api.frevanaApi.request('POST', `/s3/content/${contentId}/prepare-translate`, { target_language: firstLang });\n    if (!prepareResp.ok) throw new Error('Failed to prepare translation');\n    \n    const downloadUrl = prepareResp.data.download_url;\n    const response = await api.fetch(downloadUrl);\n    originalHtml = await response.text();\n    console.log(`Downloaded ${originalHtml.length} characters`);\n  }\n  \n  return JSON.stringify({ contentId, languages, originalHtml });\n};",
      "nodeIds": ["content-url-input", "target-languages-input"]
    },
    {
      "id": "extract-languages",
      "nameV2": "Extract Languages",
      "type": "script",
      "outputFormat": "text",
      "script": "module.exports = async function() {\n  const setupData = JSON.parse(data['setup'] || '{}');\n  const languages = setupData.languages || [];\n  if (languages.length === 0) throw new Error('No languages to translate');\n  console.log(`Extracted ${languages.length} languages: ${languages.join(', ')}`);\n  return languages.join('\\n');\n};",
      "nodeIds": ["setup"]
    },
    {
      "id": "translate-loop",
      "nameV2": "Translate All Languages",
      "type": "loop",
      "outputFormat": "text",
      "subNodes": [
        {
          "id": "check-prepare",
          "nameV2": "Check Translation Status",
          "type": "script",
          "outputFormat": "text",
          "script": "module.exports = async function() {\n  const setupData = JSON.parse(data['setup'] || '{}');\n  const lang = data['translate-loop-loop'] || '';\n  const contentId = setupData.contentId;\n  const originalHtml = setupData.originalHtml;\n  \n  if (!contentId) throw new Error('Missing content ID');\n  console.log(`[${lang}] Checking translation status...`);\n  \n  // Check local database first\n  const existingTranslation = await api.db.getByContentAndLanguage(contentId, lang);\n  if (existingTranslation) {\n    console.log(`[${lang}] Found in local database (ID: ${existingTranslation.id})`);\n    return JSON.stringify({ skip: true, lang, status: 'local_existing', id: existingTranslation.id });\n  }\n  \n  // Check S3\n  const versionsResp = await api.frevanaApi.request('GET', `/s3/content/${contentId}/language-versions`);\n  if (versionsResp.ok && versionsResp.data?.versions) {\n    const existing = versionsResp.data.versions.find(v =\u003E v.language_code === lang);\n    if (existing) {\n      console.log(`[${lang}] Found in S3`);\n      return JSON.stringify({ skip: true, lang, status: 's3_existing', id: existing.content_id, url: existing.url });\n    }\n  }\n  \n  // Need to translate\n  console.log(`[${lang}] Need translation`);\n  return JSON.stringify({ skip: false, lang, html: originalHtml });\n};",
          "nodeIds": ["setup", "translate-loop-loop"]
        },
        {
          "id": "translate-html",
          "nameV2": "Translate HTML",
          "type": "local_translate",
          "outputFormat": "text",
          "nodeIds": ["check-prepare"]
        },
        {
          "id": "save-translation",
          "nameV2": "Save to Database",
          "type": "script",
          "outputFormat": "text",
          "script": "module.exports = async function() {\n  const prep = JSON.parse(data['check-prepare'] || '{}');\n  const translatedHtml = data['translate-html'] || '';\n  const lang = prep.lang;\n  const setupData = JSON.parse(data['setup'] || '{}');\n  const contentId = setupData.contentId;\n  \n  if (!contentId) {\n    throw new Error('Missing content ID in save-translation step');\n  }\n  \n  if (prep.skip) {\n    console.log(`[${lang}] Skipped - ${prep.status}`);\n    return JSON.stringify({ lang, status: prep.status, skipped: true, id: prep.id });\n  }\n  \n  // Extract title from translated HTML\n  const titleMatch = translatedHtml.match(/\u003Ctitle[^\u003E]*\u003E([^\u003C]+)\u003C\\/title\u003E/i);\n  const title = titleMatch?.[1]?.trim() || `Translated to ${lang}`;\n  \n  // Save to local database\n  const translation = await api.db.createTranslation({\n    original_content_id: contentId,\n    language_code: lang,\n    translated_html: translatedHtml,\n    title,\n    status: 'draft'\n  });\n  \n  console.log(`[${lang}] Saved to database (ID: ${translation.id})`);\n  return JSON.stringify({ lang, status: 'translated', id: translation.id, title });\n};",
          "nodeIds": ["check-prepare", "translate-html", "setup"]
        }
      ],
      "prompt": "@[Step-2 Extract Languages](extract-languages)",
      "nodeIds": ["extract-languages"]
    },
    {
      "id": "report",
      "nameV2": "Translation Report",
      "type": "script",
      "outputFormat": "text",
      "script": "module.exports = async function() {\n  const results = data['translate-loop'] || '';\n  if (!results) return 'No translations completed';\n  \n  let items = [];\n  const normalizeItem = (entry) =\u003E {\n    if (!entry) return null;\n    if (typeof entry === 'string') {\n      try {\n        return JSON.parse(entry);\n      } catch (e) {\n        return { raw: entry };\n      }\n    }\n    if (typeof entry === 'object') return entry;\n    return { raw: String(entry) };\n  };\n  \n  try {\n    const parsed = JSON.parse(results);\n    if (Array.isArray(parsed)) {\n      items = parsed.map(normalizeItem).filter(Boolean);\n    } else if (parsed && typeof parsed === 'object') {\n      items = [normalizeItem(parsed)].filter(Boolean);\n    } else {\n      throw new Error('Unexpected loop result format');\n    }\n  } catch (e) {\n    try {\n      const lines = results.split('\\n').filter(l =\u003E l.trim());\n      items = lines.map(l =\u003E JSON.parse(l));\n    } catch (innerError) {\n      return `Failed to parse workflow results: ${innerError.message || innerError}`;\n    }\n  }\n  \n  const setupData = JSON.parse(data['setup'] || '{}');\n  const contentId = setupData.contentId || 'N/A';\n  \n  const extractTitleFromHtml = (html) =\u003E {\n    if (!html) return '';\n    const titleMatch = html.match(/\u003Ctitle[^\u003E]*\u003E([^\u003C]+)\u003C\\/title\u003E/i);\n    if (titleMatch?.[1]) return titleMatch[1].trim();\n    const h1Match = html.match(/\u003Ch1[^\u003E]*\u003E([\\s\\S]*?)\u003C\\/h1\u003E/i);\n    if (h1Match?.[1]) {\n      return h1Match[1].replace(/\u003C[^\u003E]*\u003E/g, '').trim();\n    }\n    return '';\n  };\n  \n  const getUrlFromVersion = (version) =\u003E {\n    if (!version) return '';\n    return (\n      version.url ||\n      version.download_url ||\n      version.content_url ||\n      version.preview_url ||\n      ''\n    );\n  };\n  \n  const s3UrlMap = new Map();\n  const s3TitleMap = new Map();\n  \n  if (contentId !== 'N/A') {\n    try {\n      const versionsResp = await api.frevanaApi.request(\n        'GET',\n        `/s3/content/${contentId}/language-versions`,\n      );\n      if (versionsResp.ok && versionsResp.data?.versions) {\n        versionsResp.data.versions.forEach((version) =\u003E {\n          const languageCode = version.language_code\n            ? String(version.language_code).toLowerCase()\n            : '';\n          if (!languageCode) return;\n          const resolvedUrl = getUrlFromVersion(version);\n          if (resolvedUrl) {\n            s3UrlMap.set(languageCode, resolvedUrl);\n          }\n          if (version.title) {\n            s3TitleMap.set(languageCode, version.title);\n          }\n        });\n      }\n    } catch (error) {\n      console.log(`Failed to load S3 versions: ${error?.message || error}`);\n    }\n  }\n  \n  const enrichItems = async (list) =\u003E {\n    const enriched = [];\n    for (const item of list) {\n      const rawLang = item.lang || item.language_code || item.language || '';\n      const langCode = rawLang ? String(rawLang).toLowerCase() : '';\n      let title = item.title;\n      let resolvedId = item.id;\n      let resolvedUrl = item.url;\n  \n      if (langCode && !resolvedUrl && s3UrlMap.has(langCode)) {\n        resolvedUrl = s3UrlMap.get(langCode);\n      }\n  \n      if ((!title || title === 'N/A') && langCode && s3TitleMap.has(langCode)) {\n        title = s3TitleMap.get(langCode);\n      }\n  \n      if ((!title || title === 'N/A') && contentId !== 'N/A' && langCode) {\n        const localTranslation = await api.db.getByContentAndLanguage(contentId, langCode);\n        if (localTranslation) {\n          title = localTranslation.title || title;\n          resolvedId = resolvedId || localTranslation.id;\n        }\n      }\n  \n      if ((!title || title === 'N/A') && resolvedUrl) {\n        try {\n          const response = await api.fetch(resolvedUrl);\n          const htmlText = await response.text();\n          const extractedTitle = extractTitleFromHtml(htmlText);\n          if (extractedTitle) {\n            title = extractedTitle;\n          }\n        } catch (error) {\n          console.log(`Failed to fetch title for ${rawLang}: ${error?.message || error}`);\n        }\n      }\n  \n      enriched.push({ ...item, title, id: resolvedId, url: resolvedUrl });\n    }\n    return enriched;\n  };\n  \n  items = await enrichItems(items);\n  \n  const translatedCount = items.filter(i =\u003E i.status === 'translated').length;\n  const skippedCount = items.filter(i =\u003E i.skipped).length;\n  \n  const buildPreviewLink = (item) =\u003E {\n    const idValue = item.id;\n    const numericId = Number(idValue);\n    if (Number.isFinite(numericId)) {\n      return `[Preview](frevana-translation-preview://preview?id=${encodeURIComponent(numericId)})`;\n    }\n    if (item.url) {\n      return `[Preview](frevana-translation-preview://preview?url=${encodeURIComponent(item.url)})`;\n    }\n    return 'N/A';\n  };\n  \n  const getStatusLabel = (item) =\u003E {\n    if (item.status === 'translated') return 'Translated';\n    if (item.status === 'local_existing') return 'Already translated (local)';\n    if (item.status === 's3_existing') return 'Already translated (cloud)';\n    if (item.skipped) return 'Skipped';\n    return item.status || 'Unknown';\n  };\n  \n  let md = '# Translation Completed\\n\\n';\n  md += `**Content ID:** ${contentId}\\n\\n`;\n  md += `**Total:** ${items.length} | **Translated:** ${translatedCount} | **Skipped:** ${skippedCount}\\n\\n`;\n  md += '## Translation Summary\\n\\n';\n  md += '| Language | Status | Title | Preview |\\n';\n  md += '|----------|--------|-------|---------|\\n';\n  items.forEach(i =\u003E {\n    const rawLang = i.lang || i.language_code || i.language || '';\n    const lang = rawLang ? String(rawLang).toUpperCase() : 'N/A';\n    const title = i.title || 'N/A';\n    md += `| ${lang} | ${getStatusLabel(i)} | ${title} | ${buildPreviewLink(i)} |\\n`;\n  });\n  md += '\\n\\nTranslations are ready for review.\\n\\n';\n  md += 'Next steps:\\n';\n  md += '- Preview each translation\\n';\n  md += '- Edit if needed\\n';\n  md += '- Publish when ready\\n';\n  \n  return md;\n};",
      "nodeIds": ["translate-loop", "setup"]
    }
  ],
  "results": [{ "type": "plain_text", "fields": [], "items": { "content": "report" } }],
  "inputValues": {},
  "version": "1.0",
  "metadata": { "author": "Leo Liu", "createdAt": "2025-12-20T00:31:08.928Z" },
  "frequency": "-1",
  "mcpConfigs": {},
  "workflowConnects": []
}
